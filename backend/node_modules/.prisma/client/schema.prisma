generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum LessonType {
  grammar
  vocabulary
  practice
}

enum QuestionCategory {
  grammar
  vocabulary
}

enum QuestionType {
  multiple_choice
  fill_blank
  true_false
  matching
}

enum ExamStatus {
  in_progress
  completed
  expired
}

// ==================== MODELS ====================

model User {
  id                      String    @id @default(uuid())
  googleId                String?   @unique @map("google_id")
  email                   String    @unique
  name                    String
  passwordHash            String?   @map("password_hash")
  emailVerified           Boolean   @default(false) @map("email_verified")
  verificationCode        String?   @map("verification_code")
  verificationCodeExpires DateTime? @map("verification_code_expires")
  resetToken              String?   @map("reset_token")
  resetTokenExpires       DateTime? @map("reset_token_expires")
  avatarUrl               String?   @map("avatar_url")
  totalXp                 Int       @default(0) @map("total_xp")
  currentStreak           Int       @default(0) @map("current_streak")
  longestStreak           Int       @default(0) @map("longest_streak")
  lastActivityDate        DateTime? @map("last_activity_date")
  createdAt               DateTime  @default(now()) @map("created_at")

  userProgress       UserProgress[]
  lessonCompletions  LessonCompletion[]
  exams              Exam[]
  examAttempts       ExamAttempt[]
  levelResets        LevelReset[]
  podcastCompletions PodcastCompletion[]
  aiChatSessions     AiChatSession[]
  aiChatMessages     AiChatMessage[]

  @@map("users")
}

model Level {
  id           String  @id @default(uuid())
  code         String  @unique
  name         String
  description  String?
  orderIndex   Int?    @map("order_index")
  requiredXp   Int     @default(0) @map("required_xp")
  badgeIconUrl String? @map("badge_icon_url")

  // YouTube Podcast Fields
  podcastYoutubeId       String? @map("podcast_youtube_id")
  podcastTitle           String? @map("podcast_title")
  podcastDescription     String? @map("podcast_description")
  podcastDurationMinutes Int?    @map("podcast_duration_minutes")

  createdAt DateTime @default(now()) @map("created_at")

  lessons             Lesson[]
  userProgress        UserProgress[]
  exams               Exam[]
  examAttempts        ExamAttempt[]
  questions           Question[]
  levelResets         LevelReset[]
  podcastVocabularies PodcastVocabulary[]
  podcastExercises    PodcastExercise[]
  podcastCompletions  PodcastCompletion[]

  @@map("levels")
}

model UserProgress {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  levelId          String   @map("level_id")
  lessonsCompleted Int      @default(0) @map("lessons_completed")
  totalLessons     Int      @default(0) @map("total_lessons")
  isExamUnlocked   Boolean  @default(false) @map("is_exam_unlocked")
  examsPassed      Int      @default(0) @map("exams_passed")
  examsFailed      Int      @default(0) @map("exams_failed")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@unique([userId, levelId])
  @@map("user_progress")
}

model Lesson {
  id               String     @id @default(uuid())
  levelId          String     @map("level_id")
  title            String
  description      String?
  type             LessonType
  orderIndex       Int        @map("order_index")
  content          Json
  xpReward         Int        @default(10) @map("xp_reward")
  estimatedMinutes Int        @default(15) @map("estimated_minutes")
  createdAt        DateTime   @default(now()) @map("created_at")

  level       Level              @relation(fields: [levelId], references: [id], onDelete: Cascade)
  completions LessonCompletion[]

  @@map("lessons")
}

model LessonCompletion {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  lessonId         String   @map("lesson_id")
  score            Int?
  timeSpentSeconds Int?     @map("time_spent_seconds")
  completedAt      DateTime @default(now()) @map("completed_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("lesson_completions")
}

model Question {
  id               String           @id @default(uuid())
  levelId          String           @map("level_id")
  category         QuestionCategory
  type             QuestionType
  questionText     String           @map("question_text")
  options          Json?
  correctAnswer    String           @map("correct_answer")
  explanation      String?
  difficultyWeight Int              @default(1) @map("difficulty_weight")
  tags             String[]         @default([])
  isActive         Boolean          @default(true) @map("is_active")
  createdAt        DateTime         @default(now()) @map("created_at")

  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@map("questions")
}

model Exam {
  id               String     @id @default(uuid())
  userId           String     @map("user_id")
  levelId          String     @map("level_id")
  status           ExamStatus
  questions        Json
  answers          Json       @default("{}")
  score            Decimal?   @db.Decimal(5, 2)
  passed           Boolean?
  startedAt        DateTime   @default(now()) @map("started_at")
  completedAt      DateTime?  @map("completed_at")
  expiresAt        DateTime   @map("expires_at")
  timeTakenSeconds Int?       @map("time_taken_seconds")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@map("exams")
}

model ExamAttempt {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  levelId       String   @map("level_id")
  examId        String   @map("exam_id")
  attemptNumber Int      @map("attempt_number")
  score         Decimal  @db.Decimal(5, 2)
  passed        Boolean
  attemptedAt   DateTime @default(now()) @map("attempted_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@map("exam_attempts")
}

model LevelReset {
  id      String   @id @default(uuid())
  userId  String   @map("user_id")
  levelId String   @map("level_id")
  reason  String
  resetAt DateTime @default(now()) @map("reset_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@map("level_resets")
}

model PodcastVocabulary {
  id               String   @id @default(uuid())
  levelId          String   @map("level_id")
  word             String
  definition       String
  example          String
  translation      String?
  timestampSeconds Int?     @map("timestamp_seconds")
  orderIndex       Int      @map("order_index")
  createdAt        DateTime @default(now()) @map("created_at")

  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@map("podcast_vocabularies")
}

model PodcastExercise {
  id            String   @id @default(uuid())
  levelId       String   @map("level_id")
  questionText  String   @map("question_text")
  options       Json
  correctAnswer String   @map("correct_answer")
  explanation   String?
  orderIndex    Int      @map("order_index")
  createdAt     DateTime @default(now()) @map("created_at")

  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@map("podcast_exercises")
}

model PodcastCompletion {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  levelId        String   @map("level_id")
  score          Int
  totalQuestions Int      @map("total_questions")
  completedAt    DateTime @default(now()) @map("completed_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@unique([userId, levelId])
  @@map("podcast_completions")
}

model AiChatSession {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  sessionId     String   @map("session_id")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  lastMessageAt DateTime @default(now()) @map("last_message_at")

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AiChatMessage[]

  @@unique([userId, sessionId])
  @@map("ai_chat_sessions")
}

model AiChatMessage {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  userId    String   @map("user_id")
  role      String
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  session AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_chat_messages")
}
